<!-- /.Fixed navbar  -->
{{#with product}}
<div class="container main-container headerOffset">
  <div class="row">
    <div class="breadcrumbDiv col-lg-12">
      <ul class="breadcrumb">
        <li> <a href="/cms_index">หน้าหลัก</a> </li>
        <li> <a href="/ecom_product?product_id={{id}}">{{name}}</a> </li>
      </ul>
    </div>
  </div>
  <div class="row transitionfx">
  
   <!-- left column -->
    <div class="col-lg-6 col-md-6 col-sm-6">
    	<!-- product Image and Zoom -->
      <div class="main-image sp-wrap col-lg-12 no-padding" style="display: inline-block;"> 
         
        
         
          {{#if image}}
              <div class="sp-large"><a href="#" class=""><img src="{{file_path image}}" id="display_image" class="img-responsive" alt="img"></a></div>
          {{/if}}
          <div class="sp-thumbs sp-tb-active">
          {{#if image}}
          <a href="#" class="sp-current other-image" data-img-url="{{file_path image}}"><img src="{{file_path image thumbnail=1}}" class="img-responsive" alt="{{name}}" title={{description}} data-img-url="{{file_path image}}"></a>
          {{/if}}
          {{#each images order="title"}}
              {{#if_match title "OTHER_%"}}
              <a href="#" class="sp-current other-image" data-img-url="{{file_path image}}"><img src="{{file_path image thumbnail=1}}" class="img-responsive" alt="{{description}}" title="{{description}}" data-img-url="{{file_path image}}"></a>
              {{/if_match}}
          {{/each}}
          </div>
      </div>
    </div><!--/ left column end -->
    
    
    <!-- right column -->
    <div class="col-lg-6 col-md-6 col-sm-5">
    
        <h1 class="product-title">{{name}}</h1><span id="variant_name"></span>
        <h3 class="product-code">{{code}}</h3>
      
      <div class="details-description" style="overflow-x:auto">
          <p>{{description}}</p>
      </div>

      <div class="product-attributes">
        {{#each attributes}}
          {{#if_match attribute_id.name "_%"}}
          {{else}}
          <div class="row" style="margin-left:0">
              <div class="col-xs-5">
                  {{#with attribute_id}}
                  <b>{{{editable_field "name" text_only=true}}}</b>
                  {{/with}}
              </div>
              <div class="col-xs-7">
                  {{{editable_field "value" text_only=true}}}
              </div>
          </div>
          {{/if_match}}
        {{/each}}
      </div>
      <div class="gap"></div>
      
<form action="ecom_cart_add" method="post" class="add-to-cart-form">
    {{#if custom_options}}
      <div class="productFilter">
          <span><b>กรุณาเลือกประเภทของสินค้า</b></span>
          {{#each custom_options}}
            <div class="form-group" style="margin-bottom:10px">
                <label>{{name}}</label>
                <select name="_CUST_OPT_{{code}}" class="form-control variants-select">
                    {{#each values}}
                    <option value="{{code}}">{{name}}</option>
                    {{/each}}
                </select>
            </div>
          {{/each}}
      </div>
      <!-- productFilter -->
    {{/if}}

      <div class="product-price"> 
          <span class="price-sales" id="price_sale">{{currency ecom_sale_price}} ฿</span> 
          <span class="price-standard" id="price_old">{{#if ecom_has_discount}}{{currency sale_price}} ฿{{/if}}</span> 
      </div>
      
      <div class="cart-actions">
        <div class="addto">
          <input type="hidden" id="product_id" name="product_id" value="{{id}}"/>
          <button class="button btn-cart cart first" id="add_to_cart_btn" title="Add to Cart" type="submit">หยิบลงตะกร้า</button>
          <!--
          <a class="link-wishlist wishlist" id="add_wishlist">เพิ่มในสิ่งที่ปรารถนา</a> 
          -->
        </div>
          
        <div style="clear:both"></div>
        {{#compare stock_qty 0 operator="<="}} 
            <h3 id="qty_out_of_stock" class="incaps"><i class="fa fa-minus-circle color-out"></i> สินค้าหมด </h3>
            <h3 id="qty_in_stock" style="display:none" class="incaps"><i class="fa fa fa-check-circle-o color-in"></i> มีสินค้า </h3>
        {{/compare}}
        {{#compare stock_qty 0 operator=">"}} 
            <h3 id="qty_out_of_stock" style="display:none" class="incaps"><i class="fa fa-minus-circle color-out"></i> สินค้าหมด </h3>
            <h3 id="qty_in_stock" class="incaps"><i class="fa fa fa-check-circle-o color-in"></i> มีสินค้า </h3>
        {{/compare}}
        <h3 id="no_variant" style="display:none" class="incaps"><i class="fa fa fa-minus-circle color-out"></i>ไม่มีสินค้าประเภทนี้</h3>
      </div>
      <!--/.cart-actions-->
</form>

      <div class="clear"></div>
      
      <div class="product-tab w100 clearfix">
      
        <ul class="nav nav-tabs">
            <li class="active"><a href="#details" data-toggle="tab">รายละเอียด</a></li>
            {{#each attributes}}
                {{#ifeq attribute_id.name "_BRA_CHART"}}
                    <li> <a href="#bra" data-toggle="tab">Bra Chart</a></li>
                {{/ifeq}}
                {{#ifeq attribute_id.name "_PANTY_CHART"}}
                    <li> <a href="#panty" data-toggle="tab">Panty Chart</a></li>
                {{/ifeq}}
                {{#ifeq attribute_id.name "_SHOES_CHART"}}
                    <li> <a href="#shoes" data-toggle="tab">Shoes Chart</a></li>
                {{/ifeq}}
            {{/each}}
            <!--
            <li> <a href="#review" data-toggle="tab">รีวิว</a></li>
            -->
        </ul>
        
        <!-- Tab panes -->
        <div class="tab-content">
          <div class="tab-pane active" id="details">
             {{{editable_field "details"}}}<br>
          </div>
          <div class="tab-pane" id="bra">
              <table class="table table-striped">
                  <thead>
                      <th>ขนาด (CUP)</th>
                      <th>รอบอก-ใต้อก (cm.)</th>
                      <th>ขนาดลำตัว (Size)</th>
                      <th>รอบใต้อก (cm.)</th>
                  </thead>
                  <tr>
                      <td>AA</td>
                      <td>6.5-8.5</td>
                      <td>65</td>
                      <td>63-67</td>
                  </tr>
                  <tr>
                      <td>A</td>
                      <td>9.0-11.0</td>
                      <td>70</td>
                      <td>68-72</td>
                  </tr>
                  <tr>
                      <td>B</td>
                      <td>11.5-13.5</td>
                      <td>75</td>
                      <td>73-77</td>
                  </tr>
                  <tr>
                      <td>C</td>
                      <td>14.0-16.0</td>
                      <td>80</td>
                      <td>78-82</td>
                  </tr>
                  <tr>
                      <td>D</td>
                      <td>16.5-18.5</td>
                      <td>85</td>
                      <td>83-87</td>
                  </tr>
                  <tr>
                      <td>E</td>
                      <td>19.0-21.0</td>
                      <td>90</td>
                      <td>88-92</td>
                  </tr>
                  <tr>
                      <td>F</td>
                      <td>21.5-23.5</td>
                      <td>95</td>
                      <td>93-97</td>
                  </tr>
                  <tr>
                      <td></td>
                      <td></td>
                      <td>100</td>
                      <td>98-102</td>
                  </tr>
                  <tr>
                      <td></td>
                      <td></td>
                      <td>105</td>
                      <td>103-107</td>
                  </tr>
                  <tr>
                      <td></td>
                      <td></td>
                      <td>110</td>
                      <td>108-112</td>
                  </tr>
              </table>
          </div>
          <div class="tab-pane" id="panty">
              <table class="table table-striped">
                  <thead>
                      <th>Size</th>
                      <th>ขนาดสะโพก (cm.)</th>
                  </thead>
                  <tr>
                      <td>S</td>
                      <td>80-88</td>
                  </tr>
                  <tr>
                      <td>M</td>
                      <td>85-93</td>
                  </tr>
                  <tr>
                      <td>L</td>
                      <td>90-98</td>
                  </tr>
                  <tr>
                      <td>LL</td>
                      <td>95-103</td>
                  </tr>
                  <tr>
                      <td>EL</td>
                      <td>100-108</td>
                  </tr>
                  <tr>
                      <td>EEL</td>
                      <td>105-113</td>
                  </tr>
                  <tr>
                      <td>3E</td>
                      <td>110-118</td>
                  </tr>
                  <tr>
                      <td>4E</td>
                      <td>115-123</td>
                  </tr>
                  <tr>
                      <td>5E</td>
                      <td>120-128</td>
                  </tr>
              </table>
          </div>
          <div class="tab-pane" id="shoe">
              <span> sssssss</span><br>
          </div>
          <div class="tab-pane" id="review">
            <span id="wait_approve" style="display:none;color:#808080">รีวิวของคุณได้ถูกส่งไปยังระบบแล้ว กรุณารอการอณุมัติ</span>
            <form action="/" method="post" class="review-form">
                <p><b>เขียนรีวิว</b></p>
                <div class="col-xs-6">
                    <input id="review_name" class="review_form" type="text" placeholder='ชื่อของคุณ'/>
                </div>
                <div class="col-xs-6">
                    <input id="review_title" class="review_form" type="text" placeholder='หัวข้อ'/>
                </div>
                <div class="col-xs-12">
                    <textarea id="review_review" class="review_form" placeholder='เขียนรีวิว...'></textarea>
                </div>
                <div class="row" style="margin-left:0px;margin-right:0px">
                    <div class="col-xs-6">
                        <div id="review_rate"></div>
                    </div>
                        <div class="col-xs-6">
                        <button id="add_review_btn" type="submit" class="btn btn-default pull-right">ยืนยัน
                        </button>
                    </div>
                </div>
            </form>
            <div class="row" id="review_validator" style="text-aligh:right;color:#FF0000"></div>
            {{#if review}}
            {{#each review}}
                {{#if_match state "approved"}}
                <HR>
                <ul style="margin-top:20px">
                    <li><a><i class="fa fa-user"></i>{{name}}</a></li>
                    <li><a><i class="fa fa-calendar-o"></i>{{date}}</a></li>
                    <li><div class="review_rate" data-score="{{rating}}"</div></li>
                </ul>
                <p><b>{{title}}</b></p>
                <p>{{review}}</p>
                {{/if_match}}
            {{/each}}
            {{/if}}
          </div>
          
        </div> <!-- /.tab content -->
        
      </div><!--/.product-tab-->
      
      <div style="clear:both"></div>
      
      <div class="product-share clearfix" style="overflow-x:auto">
            <p> LIKE&SHARE</p>
            <div class="socialIcon"> 
                <div class="fb-like" data-href="" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
            </div>

      </div>
      <!--/.product-share--> 
      
    </div><!--/ right column end -->
    
  </div>
  <!--/.row-->
  {{#if related_products}} 
  <div class="row recommended">
  
    <h1> สินค้าที่เกี่ยวข้อง </h1>
        {{#each related_products}}
        <div class="item col-lg-3 col-md-3 col-sm-4 col-xs-6" style="height:auto;max-height:480px">
          <div class="product">
              <!--
              <a class="add-fav tooltipHere add-wishlist" data-product-id={{id}} data-toggle="tooltip" data-original-title="Add to Wishlist" data-placement="left">
                <i class="glyphicon glyphicon-heart" data-product-id={{id}}></i>
            </a>
              -->
            <div class="image"> <a href="/ecom_product?product_id={{id}}"><img src="{{file_path image thumbnail=1}}" alt="img" class="img-responsive"></a>
                <div class="promotion"> 
                    {{#if discount_text}}
                        <span class="discount">{{discount_text}}</span>
                    {{/if}}
                </div>
            </div>
            <div class="description">
                <h4><a href="/ecom_product?product_id={{id}}">{{name}}</a></h4>
                <p>{{description}}</p>
            </div>
              <div class="price"> 
                  <span>{{currency ecom_sale_price}} ฿</span>
                  {{#if ecom_has_discount}}
                      <span class="old-price">{{currency sale_price}}</span>
                  {{/if}}
              </div>
              <div class="action-control"> <a class="btn btn-primary" href="/ecom_product?product_id={{id}}"> <span class="add2cart"><i class="glyphicon glyphicon-shopping-cart"> </i> ซื้อ </span> </a> </div>
          </div>
        </div>
        {{/each}}
  </div>
  {{/if}}
  
  
  <div style="clear:both"></div>
  
  
</div> <!-- /main-container -->


<div class="gap"></div>
{{/with}}

<script>
var product={{{product_json}}};
var variants=[];

function review_form(){
    if ($("#review_name").val() === "" || $("#review_title").val() === "" || $("#review_review").val() === ""){
        $("#review_validator").text("กรุณากรอกข้อมูลให้ครบถ้วน").show().fadeOut(2000);
    }
    else{
        var url="ecom_review_add",
            name = $("#review_name").val(),
            title = $("#review_title").val(),
            review = $("#review_review").val(),
            rating = $("#review_rate").raty('score'),
            product_id =  $("#product_id").val();
        if (rating==undefined){
            rating = 0;
        }
        var posting = $.post(url, {name: name, title: title, review: review, rating: rating, product_id: product_id});

        posting.done(function( data ) {
            $(".review-form").slideUp();
            $("#wait_approve").show();
            //console.log("review hide");
        });
    }
}

function change_variants(){
    var variant_values=[];
    var is_match=false;
    var match_product;
    $(".variants-select").each(function(index){
        variant_values.push($(this).val());
    });
    _.each(variants,function(product) {
        is_match = _.every(variant_values,function(e){
            if(_.contains(product.attr_str,e)){
                return true;
            }
        });
        if(is_match){
            match_product=product;
        }
    });

    //console.log(match_product);
    if(match_product){
        if(match_product.price){
            price=match_product.price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            $("#price_sale").html(price+" ฿");
        }
        else if(product.sale_price){
            price=product.sale_price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            $("#price_sale").html(price+" ฿");
        }
        else{
            $("#price_sale").html("");
        }

        if(match_product.old_price){
            old_price=match_product.old_price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            $("#price_old").html(old_price+" ฿");
        }
        else if(product.old_price){
            old_price=product.old_price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
            $("#price_old").html(old_price+" ฿");
        }
        else{
            $("#price_old").html("");
        }
        if(match_product.stock_qty > 0){
            $("#qty_out_of_stock").hide();
            $("#qty_in_stock").show();
            $("#add_to_cart_btn").show();
        }
        else{
            $("#qty_out_of_stock").show();
            $("#qty_in_stock").hide();
            $("#add_to_cart_btn").hide();
        }
        $("#no_variant").hide();
    }
    else{
        $("#qty_out_of_stock").hide();
        $("#qty_in_stock").hide();
        $("#add_to_cart_btn").hide();
        $("#no_variant").show();
    }
        
}

function update_variants(cb){
    _.each(product.variants,function(variant) {
        //console.log(variant.attr_str);
        variants.push(variant);
    });
    cb();
}

$(function() {
    $(".review-form").submit(function(e) {
        e.preventDefault();
        review_form();
    });
});

$("#add_wishlist").click(function(e) {
    product_id = $("#product_id").val();
    //console.log(product_id);
    url = "ecom_wishlist_add";
    var posting = $.post(url, {product_id: product_id});

    posting.done(function(data) {
        location.replace("/ecom_wishlist");
    });
});

$("#review_rate").raty({
    path: '/static/db/{{database}}/themes/tshop/img',
    cancel:true,
});

$(".review_rate").raty({
    path: '/static/db/{{database}}/themes/tshop/img',
    score: function(){
        return $(this).attr('data-score');
    },
    readOnly: true,
});

$(".variants-select").change(function(){
    change_variants();
    //console.log("Variants Change");
});

$(".other-image").click(function(e){
    e.preventDefault();
    img_url=$(e.target).data("img-url");
    $("#display_image").attr('src',img_url);
});

$(document).ready(function(){
    if ($("#qty_out_of_stock").is(":visible")){
        $("#add_to_cart_btn").hide();
    }
    update_variants(function(){
        //console.log(product.type);
        if (product.type == "master"){
        change_variants();       
        }
    });
});

</script>
